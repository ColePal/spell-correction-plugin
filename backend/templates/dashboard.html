{% load static %}
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <link rel="icon" href="{% static 'favicon.ico' %}">

        <title>Dashboard</title>

        <link rel="canonical" href="https://getbootstrap.com/docs/4.0/examples/cover/" />

        <!-- Bootstrap CSS and Icons-->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet" />

        <!-- Custom CSS and BG Image -->
<!--        <link href="{% static 'css/templateStyles.css' %}" rel="stylesheet"/>-->
        <link href="{% static 'css/dashboardStyles.css' %}" rel="stylesheet"/>
        <link href="{% static 'css/navbar.css' %}" rel="stylesheet"/>

    </head>

    <body class="text-center">

        <div class="cover-container d-flex h-100 p-3 mx-auto flex-column">
            {% include "partials/navbar.html" %}

<!--<div class="d-flex">-->
<!--  <div class="flex-shrink-0 p-3 bg-dark text-white" style="width: 220px;">-->
<!--    <h5>Customize Dashboard</h5>-->
<!--    <br>-->
<!--    <h6>Select analytics you want to see</h6>-->
<!--    <br>-->

<!--    <form id="widget-picker" class="vstack gap-2">-->
<!--        <ul >-->
<!--            <li>-->
<!--      <label class="form-check">-->
<!--        <input class="form-check-input" type="checkbox" value="languages" />-->
<!--        <span class="form-check-label">Language Usage</span>-->
<!--      </label>-->
<!--                </li>-->
<!--            <li>-->
<!--      <label class="form-check">-->
<!--        <input class="form-check-input" type="checkbox" value="mistakes" />-->
<!--        <span class="form-check-label">Mistakes Chart</span>-->
<!--      </label>-->
<!--            </li>-->
<!--            <li>-->
<!--         <label class="form-check">-->
<!--        <input class="form-check-input" type="checkbox" value="mistakes" />-->
<!--        <span class="form-check-label">Spelling Analytics</span>-->
<!--      </label>-->
<!--            </li>-->
<!--        </ul>-->
<!--    </form>-->
<!--  </div>-->
<!--</div>-->
            <section id="user-section" class="flex-row d-flex justify-content-around">
                <h1>Dashboard for {{ user_profile.username }}</h1>
                <h1>Account Created {{ user_profile.joined_at }}</h1>
            </section>

            <section id="analytic_space" class="dash-grid"></section>
            <div class="row g-3 mb-3">
                <div class="col-12 col-md-4">
                    <div class="card">
                        <div class="card-body">Language Usage (queries per language)</div>
                        <canvas id="languages_chart"></canvas>
                    </div>
                </div>
                <div class="col-12 col-md-4">
                    <div class="card h-100">
                        <div class="card-body">
                              <div>
                                 <strong>Most Misspelled Word:</strong>
                                 <span id="most_misspelled">Loading...</span>
                             </div>
                            <div>
                                 <strong>Total corrections:</strong>
                                 <span id="total_corrections">—</span>
                             </div>
                              <div>
                                  <strong>Unique misspelled:</strong>
                                  <span id="unique_misspelled">—</span>
                              </div>
                             <div>
                                 <strong>Unique corrected:</strong>
                                 <span id="unique_corrected">—</span>
                             </div>
                             <div>
                                 <strong>Total requests::</strong>
                                 <span id="total_requests">—</span>
                             </div>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-4">
                    <div class="card">
                        <div class="card-body">Vocabulary Richness</div>
                        <div id="vocab"></div>
                        <br><br>
                    </div>
                    <div class="card">
                        <div class="card-body">Typing Speed</div>
                        <div id="tspeed"></div>
                        <br><br>
                    </div>
                </div>
            </div>

            <div class="row g-3 mb-3">
                <div class="col-12 col-md-6">
                    <div class="card h-100">
                      <div class="card-body">
                        <div class="d-flex align-items-center justify-content-between mb-2">
                          <h5 class="mb-0">Mistakes % Over Time</h5>
                          <div class="d-flex gap-2">
                            <p id="pctUser" style="min-width:200px">
                            </p>
                            <select id="pctRange" class="form-select form-select-sm">
                              <option value="30" selected>Last 30 days</option>
                              <option value="90">Last 90 days</option>
                              <option value="180">Last 180 days</option>
                            </select>
                          </div>
                        </div>
                        <canvas id="mistake_pct_chart"></canvas>
                      </div>
                    </div>
                </div>
{#                <div class="col-12 col-md-6">#}
{#                    <div class="card h-100">#}
{#                        <div class="card-body">Did you know?</div>#}
{#                    </div>#}
{#                </div>#}
            </div>

            <!--
            Need to add some functionality to the floating button
            with the sidebar
            -->

            <button class="btn btn-primary floatingbutton">
                <i class="bi bi-plus"></i>
            </button>

            <footer class="mastfoot mt-auto">
                <div class="inner">
                    <p>LLMSpell</p>
                </div>
            </footer>
        </div>

        <!-- Bootstrap JS -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>


        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

        <!--THIS SCRIPT IS CURRENTLY EMPTY. PUT YOUR JAVASCRIPTS IN THIS FILE-->
        <script src="{% static 'js/dashboardScript.js' %}"></script>

    <script>
        let languagesChart;
        function initCharts() {
         const languages_chart = document.getElementById("languages_chart").getContext("2d");
         languagesChart = new Chart(languages_chart, {type: "doughnut", data: {labels: [], datasets: [{ data: [], borderWidth: 0,hoverOffset: 6,backgroundColor: []}]}, options: {responsive: true, plugins: { legend: { position: "bottom" } }, cutout: "60%"}}
         );}

        function randomColour() {
         const red = Math.floor(Math.random() * 255);
          const green = Math.floor(Math.random() * 255);
         const blue = Math.floor(Math.random() * 255);
         return `rgb(${red}, ${green}, ${blue})`;
}

       async function all_languages(){
         const response = await fetch("{% url 'dashboard_languages' %}");
          const data = await response.json();

           let languages = [];
           if (Array.isArray(data.languages_all)) {
               languages = data.languages_all;
           }
           const labels = languages.map(e => e.language);
           const colour = labels.map(() => randomColour());
           languagesChart.data.labels = labels;
           languagesChart.data.datasets[0].data =languages.map(e =>e.count);
           languagesChart.data.datasets[0].backgroundColor = colour;
           languagesChart.update();
        }

        async function misspelled(){
             const response = await fetch("{% url 'misspelled_word' %}");
             const data = await response.json();
               if (data.word) {
                   document.getElementById("most_misspelled").innerText = ` '${data.word}' (${data.count} times mispelled)`;
               }
               else {
                    document.getElementById("most_misspelled").innerText = "No data yet";
                }
               document.getElementById("total_corrections").textContent = data.total_corrections;
               document.getElementById("unique_misspelled").textContent = data.unique_misspelled;
               document.getElementById("unique_corrected").textContent  = data.unique_corrected;
               document.getElementById("total_requests").textContent    = data.total_requests;

        }

        let mistakeChart;


        async function percentage(days){
          const query_url = new URL("{% url 'mistakes_percentage_timeseries' %}", window.location.origin);
          query_url.searchParams.set("days", days);
            const response = await fetch(query_url);
          if (!response.ok){
              return { labels: [], series: [] };
          }
          return response.json();
        }


        async function renderMistakePct() {
          const days = document.getElementById("pctRange").value;
          const payload = await percentage(days);
          const labels = payload.labels || [];
          const series = (payload.series && payload.series[0]) || { data: [], username: "You", user_id: null };

          if (!mistakeChart) {
            const context = document.getElementById("mistake_pct_chart").getContext("2d");
            mistakeChart = new Chart(context, {
              type: "line",
              data: { labels, datasets: [] },
              options: {
                responsive: true,
                interaction: { mode: 'index', intersect: false },
                plugins: {legend: { position: 'bottom' }, tooltip: { callbacks: { label: (c) => `${c.dataset.label}: ${c.parsed.y?.toFixed(2)}%` } }},
                scales: {y: { beginAtZero: true, ticks: { callback: v => `${v}%` }, title: { display: true, text: "Mistakes (%)" } }}
              }
            }
            );
          }
          let dataset;
          if (series) {
          dataset ={
            label: series.username || (series.user_id ? `User ${series.user_id}` : "You"), data: Array.isArray(series.data) ? series.data : [],
            borderColor: randomColour(),
            fill: false,
            tension: 0.25,
            pointRadius: 1
          };}
          else {
               dataset = { label: "No data", data: labels.map(() => 0) };
          }
          mistakeChart.data.labels = labels;
          mistakeChart.data.datasets = [dataset]
          mistakeChart.update();
        }
         async function richness(){
            const response=await fetch("{% url 'richness' %}");
             const data = await response.json();
             let colour;
             if (data.richness<4){
                 colour = '#dc3545'
             }
             else if (data.richness<7){
             colour = '#ffc107'
              }
             else{
                 colour = '#28a745'
             }
            const vocab= document.getElementById("vocab");
             vocab.textContent = `${data.richness.toFixed(1)}/10`;
             vocab.style.backgroundColor = colour;
         }

         async function typeSpeed(){
            const response=await fetch("{% url 'type_speed' %}");
            const data = await response.json();
             document.getElementById("tspeed").innerText = data.speed+" wpm";

         }

        document.addEventListener('DOMContentLoaded', async () => {
          await renderMistakePct();
          document.getElementById("pctUser").addEventListener("change", renderMistakePct);
          document.getElementById("pctRange").addEventListener("change", renderMistakePct);
         });

       document.addEventListener('DOMContentLoaded', () => {
     initCharts();
     all_languages();
     misspelled();
     richness();
     typeSpeed();

  });
    </script>
    </body>
</html>
