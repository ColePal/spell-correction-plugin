<!--{% load static %}-->
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <link rel="icon" href="/docs/4.0/assets/img/favicons/favicon.ico" />

        <title>Cover Template for Bootstrap</title>

        <link rel="canonical" href="https://getbootstrap.com/docs/4.0/examples/cover/" />

        <!-- Bootstrap core CSS -->
{#        <link href="../../dist/css/bootstrap.min.css" rel="stylesheet" />#}

        <!-- Custom styles for this template -->
        <!--    <link href="cover.css" rel="stylesheet">-->

        <!-- Bootstrap CSS and Icons -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet" />

        <style>
            /*
            * Globals
            */

            /* Links */
            a,
            a:focus,
            a:hover {
                color: #fff;
            }

            /* Custom default button */
            .btn-secondary,
            .btn-secondary:hover,
            .btn-secondary:focus {
                color: #333;
                text-shadow: none; /* Prevent inheritance from `body` */
                background-color: #fff;
                border: 0.05rem solid #fff;
            }

            /*
             * Base structure
             */

            html,
            body {
                height: 100%;
                margin: 0;
            }

            body {
                display: -ms-flexbox;
                display: -webkit-box;
                display: flex;
                -ms-flex-pack: center;
                -webkit-box-pack: center;
                justify-content: center;
                color: #fff;
                text-shadow: 0 0.05rem 0.1rem rgba(0, 0, 0, 0.5);
                box-shadow: inset 0 0 5rem rgba(0, 0, 0, 0.5);
                background: url("{% static 'faded_gallery-JEludq8wsD8-unsplash.jpg' %}") no-repeat center fixed;
                background-size: cover;
            }

            .row.align-items-stretch {
                align-items: stretch;
            }

            .col-sm-3 > .card {
                height: 100%;
            }

            .cover-container {
                width: 100%;
                max-width: 100%;
                padding: 1rem;
            }

            .nav-inner {
                width: 100%;
                margin: 0 auto;
            }

            @media (min-width: 768px) {
                .nav-inner {
                    width: 60%;
                    max-width: 80%;
                }
            }

            .masthead {
                margin-bottom: 2rem;
            }

            .masthead-brand {
                margin-bottom: 0;
            }

            .nav-masthead .nav-link {
                padding: 0.25rem 0;
                font-weight: 700;
                color: rgb(255, 255, 255);
                background-color: transparent;
                border-bottom: 0.25rem solid transparent;
            }

            .nav-masthead .nav-link:hover,
            .nav-masthead .nav-link:focus {
                border-bottom-color: rgb(255, 255, 255);
            }

            .nav-masthead .nav-link + .nav-link {
                margin-left: 1rem;
            }

            .nav-masthead .active {
                color: #fff;
                border-bottom-color: #fff;
            }

            @media (min-width: 48em) {
                .masthead-brand {
                    float: left;
                }

                .nav-masthead {
                    float: right;
                }
            }

            .cover {
                padding: 0 1.5rem;
            }

            .cover .btn-lg {
                padding: 0.75rem 1.25rem;
                font-weight: 700;
            }

            .mastfoot {
                color: rgba(255, 255, 255, 0.5);
            }
            insertion {
                text-decoration: underline;
                color: yellow;
            }
            deletion {
                text-decoration: underline;
                color: blue;
            }
            replacement {
                text-decoration: underline;
                color: red;
            }
            .card-body{
                text-align: center;
                 line-height: 3;
            }
        </style>
    </head>

    <body class="text-center">
        <div class="cover-container d-flex h-100 p-3 mx-auto flex-column">
            <header class="masthead mb-auto">
                <div class="inner nav-inner" style="max-width: 80%; margin: 0 auto;">
                    <h3 class="masthead-brand" style="color: white;">LLMSpell</h3>
                    <nav class="nav nav-masthead justify-content-center">
                        <i class="fs-4 bi-house me-2 text-white"></i>
                        <a class="nav-link me-2" href="{% url 'cover' %}">Home</a>
                        <i class="fs-4 bi-speedometer2 me-2 text-white"></i>
                        <a class="nav-link active me-2" href="#">Dashboard</a>
                        <i class="fs-4 bi-envelope me-2 text-white"></i>
                        <a class="nav-link me-2" href="#">Contact</a>
                    </nav>
                </div>
            </header>
            <div class="row g-3 mb-3">
                <div class="col-12 col-md-4">
                    <div class="card">
                        <div class="card-body">Language Usage (queries per language)</div>
                        <canvas id="languages_chart"></canvas>
                    </div>
                </div>
                <div class="col-12 col-md-4">
                    <div class="card h-100">
                        <div class="card-body">
                              <div>
                                 <strong>Most Misspelled Word:</strong>
                                 <span id="most_misspelled">Loading...</span>
                             </div>
                            <div>
                                 <strong>Total corrections:</strong>
                                 <span id="total_corrections">—</span>
                             </div>
                              <div>
                                  <strong>Unique misspelled:</strong>
                                  <span id="unique_misspelled">—</span>
                              </div>
                             <div>
                                 <strong>Unique corrected:</strong>
                                 <span id="unique_corrected">—</span>
                             </div>
                             <div>
                                 <strong>Total requests::</strong>
                                 <span id="total_requests">—</span>
                             </div>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-4">
                    <div class="card h-100">
                        <div class="card-body">Session Analytics</div>
                    </div>
                </div>
            </div>

            <div class="row g-3 mb-3">
                <div class="col-12 col-md-6">
                    <div class="card h-100">
                      <div class="card-body">
                        <div class="d-flex align-items-center justify-content-between mb-2">
                          <h5 class="mb-0">Mistakes % Over Time</h5>
                          <div class="d-flex gap-2">
                            <p id="pctUser" style="min-width:200px">
                            </p>
                            <select id="pctRange" class="form-select form-select-sm">
                              <option value="30" selected>Last 30 days</option>
                              <option value="90">Last 90 days</option>
                              <option value="180">Last 180 days</option>
                            </select>
                          </div>
                        </div>
                        <canvas id="mistake_pct_chart"></canvas>
                      </div>
                    </div>
                </div>
{#                <div class="col-12 col-md-6">#}
{#                    <div class="card h-100">#}
{#                        <div class="card-body">Did you know?</div>#}
{#                    </div>#}
{#                </div>#}
            </div>

            <footer class="mastfoot mt-auto">
                <div class="inner">
                    <p>LLMSpell</p>
                </div>
            </footer>
        </div>

        <!-- Bootstrap JS -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

        <script>
            {%  include "Requester.js" %}
        </script>
        <!--<script src="SlicingAlgorithm.js"></script>-->
        <script>
            {%  include "SetupPage.js" %}
        </script>

        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let languagesChart;
        function initCharts() {
         const languages_chart = document.getElementById("languages_chart").getContext("2d");
         languagesChart = new Chart(languages_chart, {type: "doughnut", data: {labels: [], datasets: [{ data: [], borderWidth: 0,hoverOffset: 6,backgroundColor: []}]}, options: {responsive: true, plugins: { legend: { position: "bottom" } }, cutout: "60%"}}
         );}

        function randomColour() {
         const red = Math.floor(Math.random() * 255);
          const green = Math.floor(Math.random() * 255);
         const blue = Math.floor(Math.random() * 255);
         return `rgb(${red}, ${green}, ${blue})`;
}

       async function all_languages(){
         const response = await fetch("{% url 'dashboard_languages' %}");
          const data = await response.json();

           let languages = [];
           if (Array.isArray(data.languages_all)) {
               languages = data.languages_all;
           }
           const labels = languages.map(e => e.language);
           const colour = labels.map(() => randomColour());
           languagesChart.data.labels = labels;
           languagesChart.data.datasets[0].data =languages.map(e =>e.count);
           languagesChart.data.datasets[0].backgroundColor = colour;
           languagesChart.update();
        }

        async function misspelled(){
             const response = await fetch("{% url 'misspelled_word' %}");
             const data = await response.json();
               if (data.word) {
                   document.getElementById("most_misspelled").innerText = ` '${data.word}' (${data.count} times mispelled)`;
               }
               else {
                    document.getElementById("most_misspelled").innerText = "No data yet";
                }
               document.getElementById("total_corrections").textContent = data.total_corrections;
               document.getElementById("unique_misspelled").textContent = data.unique_misspelled;
               document.getElementById("unique_corrected").textContent  = data.unique_corrected;
               document.getElementById("total_requests").textContent    = data.total_requests;

        }

        let mistakeChart;


        async function percentage(days){
          const query_url = new URL("{% url 'mistakes_percentage_timeseries' %}", window.location.origin);
          query_url.searchParams.set("days", days);
            const response = await fetch(query_url);
          if (!response.ok){
              return { labels: [], series: [] };
          }
          return response.json();
        }


        async function renderMistakePct() {
          const days = document.getElementById("pctRange").value;
          const payload = await percentage(days);
          const labels = payload.labels || [];
          const series = (payload.series && payload.series[0]) || { data: [], username: "You", user_id: null };

          if (!mistakeChart) {
            const context = document.getElementById("mistake_pct_chart").getContext("2d");
            mistakeChart = new Chart(context, {
              type: "line",
              data: { labels, datasets: [] },
              options: {
                responsive: true,
                interaction: { mode: 'index', intersect: false },
                plugins: {legend: { position: 'bottom' }, tooltip: { callbacks: { label: (c) => `${c.dataset.label}: ${c.parsed.y?.toFixed(2)}%` } }},
                scales: {y: { beginAtZero: true, ticks: { callback: v => `${v}%` }, title: { display: true, text: "Mistakes (%)" } }}
              }
            }
            );
          }
          let dataset;
          if (series) {
          dataset ={
            label: series.username || (series.user_id ? `User ${series.user_id}` : "You"), data: Array.isArray(series.data) ? series.data : [],
            borderColor: randomColour(),
            fill: false,
            tension: 0.25,
            pointRadius: 1
          };}
          else {
               dataset = { label: "No data", data: labels.map(() => 0) };
          }
          mistakeChart.data.labels = labels;
          mistakeChart.data.datasets = [dataset]
          mistakeChart.update();
        }

        document.addEventListener('DOMContentLoaded', async () => {
          await renderMistakePct();
          document.getElementById("pctUser").addEventListener("change", renderMistakePct);
          document.getElementById("pctRange").addEventListener("change", renderMistakePct);
         });

         document.addEventListener('DOMContentLoaded', () => {
     initCharts();
     all_languages();
     misspelled();
  });
    </script>
    </body>
</html>
