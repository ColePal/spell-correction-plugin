<!doctype html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Writing Insight Prototype</title>
    <style>
        body,h1 {
            font-family: "Times New Roman", Times, serif;
            margin: 24px;
        }

        textarea {
            width: 96%;
            height: 160px;
            font-family: "Times New Roman", Times, serif;
            font-size: 16px;
            padding: 20px;
            border-radius: 10px;
        }

        .row {
            display: flex;
            gap: 24px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .card {
            flex: 1 1 280px;
            padding: 12px 20px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-family: "Times New Roman", Times, serif;
        }

        .mono {
            font-family: "Times New Roman", Times, serif;
            white-space: pre-wrap;
        }
    </style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<h1>Writing Insight</h1>

<p>Type below. Analysis runs after you pause typing (~500ms).</p>
<textarea id="editor" placeholder="Start typing here..."></textarea>
<div id="status" style="margin:8px 0;color:#666;"></div>
<div class="card"><h3>Language: </h3>
<p id="language"></p>
</div>
<div class="row">
    <div class="card"><h3>Emotion (%)</h3>
        <canvas id="emotionsChart" height="140"></canvas>
    </div>
    <div class="card"><h3>Formality (%)</h3>
        <canvas id="formalityChart" height="140"></canvas>
    </div>
    <div class="card"><h3>Readability (flesch_reading_ease measurement)</h3>
        <div id="readability" class="mono"></div>
        <meter id="meterFlesch" min="0" max="120" low="50" high="80" optimum="100" value="0" style="width:100%"></meter>
    </div>
    <div style="margin-top:10px">
</div>

</div>

<script>
  function fleschMeaning(score) {
    if (score > 100)
        return "Super easy (child-level simplicity)";
    if (score >= 90)
        return "Very easy (5th grade)";
    if (score >= 80)
        return "Easy (6th grade)";
    if (score >= 70)
        return "Fairly easy (7th grade)";
    if (score >= 60)
        return "Standard (8th–9th grade)";
    if (score >= 50)
        return "Fairly difficult (10th–12th grade)";
    if (score >= 30)
        return "Difficult (college level)";
    if (score >= 0)
        return "Very difficult (college graduate)";
    return "Extremely complex / academic";
  }

  let timer = null;

  let emotionsChart, formalityChart;
  let emotionsColours={
      joy:      "#f59e0b",
  sadness:  "#60a5fa",
  anger:    "#ef4444",
  fear:     "#8b5cf6",
  disgust:  "#10b981",
  surprise: "#f472b6",
  neutral:  "#9ca3af"
  }

function initCharts() {
  const emotionsElement = document.getElementById("emotionsChart").getContext("2d");
  emotionsChart = new Chart(emotionsElement, {
    type: "doughnut",
    data: {
      labels: [],
      datasets: [{ data: [], borderWidth: 0,hoverOffset: 6,backgroundColor: []}]
    },
    options: {
      responsive: true,
      plugins: { legend: { position: "bottom" } },
      cutout: "60%"
    }
  });

  const formalityElement = document.getElementById("formalityChart").getContext("2d");
  formalityChart = new Chart(formalityElement, {
    type: "bar",
    data: {
      labels: ["Formal", "Informal"],
      datasets: [{ data: [0, 0] }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: true, ticks: { callback: v => v + "%" } }
      }
    }
  });
}
document.addEventListener("DOMContentLoaded", initCharts);


async function language_detect(text) {
    const response=await fetch("/api/language/",{
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ text })
    });
    const data = await response.json();
    document.getElementById("language").textContent = (typeof data.language === "string")
      ? data.language
      : (data.language?.language ?? "und");

}

  async function analyze(text) {
    document.getElementById("status").textContent = "Analyzing…";

    const res = await fetch("/api/analyze/", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ text })
    });
    const data = await res.json();
    document.getElementById("status").textContent = "";

    if (!data.ok) {
      document.getElementById("readability").textContent = "";
      return;
    }

    let list = [];
    if (Array.isArray(data.emotion?.all)) {
      list = data.emotion.all;
    } else if (Array.isArray(data.emotion?.top)) {
      list = data.emotion.top;
    }
    const top5Emotions = list.slice(0, 5);
    const labels = top5Emotions.map(e => e.label);
    const values = top5Emotions.map(e => Math.round(e.score * 100));
    const colors = labels.map(lab => emotionsColours[lab.toLowerCase()] || "#999");
    emotionsChart.data.labels = labels;
    emotionsChart.data.datasets[0].data = values;
    emotionsChart.data.datasets[0].backgroundColor = colors;
    emotionsChart.update();


    const f = data.formality.scores || {};
    const formalPercentage = Math.round((f.label0 || 0) * 100);
    const informalPercentage = Math.round((f.label1 || 0) * 100);
    formalityChart.data.datasets[0].data = [formalPercentage, informalPercentage];
    formalityChart.update();



    const fleschValue = Number(data.readability.flesch_reading_ease);
    document.getElementById("readability").textContent = `Readability: ${fleschValue.toFixed(1)} — ${fleschMeaning(fleschValue)}\n`;
    document.getElementById("meterFlesch").value = Number(data.readability.flesch_reading_ease) || 0;
  }


  document.getElementById("editor").addEventListener("input", () => {
    clearTimeout(timer);
    timer = setTimeout(() => {
    const val = document.getElementById("editor").value;
    analyze(val);
    language_detect(val);
  }, 500);
  });
</script>
</body>
</html>
